<!DOCTYPE>
<html>
<head>
	<title>工作流程图</title>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="css/style.css">
</head>

<body>

  <div class="top-panel">
    <div class="top-left-panel">
      <input type="button" class="fl-btn" id="new-box" value="New Box">
      <input type="button" class="fl-btn" id="new-node" value="New Node">
      <input type="button" class="fl-btn" id="text-chart-align" value="Align">
      <input type="button" class="fl-btn" id="chart-save" value="Save">
    </div>
    <div class="top-right-panel">
      <input type="button" class="fl-btn" id="btn-object" value="Object">
      <input type="button" class="fl-btn" id="btn-text" value="Text">
      <input type="button" class="fl-btn" id="btn-style" value="Style">
    </div>
  </div>
  <div class="chart-content">
    <div class="chart-design droppable"></div>
    <div class="chart-right-panel">
      <div class="chart-right-list">
        <div class="chart-right-list-flag" style="display:none;visibility:hidden;">object</div>
        <div class="chart-list chart-object">
          <h4>Shape</h4>
          <div class="list-content">
              <div class="area">
                <div class="draggable" id="rect">文本</div>
                <div class="draggable roundedRect" id="roundedRect">文本</div>
                <div class="draggable circle" id="circle">文本</div>
                <div class="draggable rhombus" id="rhombus">文本</div>
              </div>
          </div>
          <h4>Location</h4>
          <div class="list-content">
            <p>agsddfgd</p>
          </div>
          <h4>Size</h4>
          <div class="list-content">
          <p>rfytuuyuy</p>
            <ul>
              <li>List item one</li>
              <li>List item two</li>
              <li>List item three</li>
            </ul>
          </div>
          <h4>Fill</h4>
          <div class="list-content">
            <p>agsddfgd</p>
          </div>
          <h4>Shadow</h4>
          <div class="list-content">
            <p>agsddfgd</p>
          </div>
        </div>

        <div class="chart-list chart-text" style="display:none;">
          <h4>Font</h4>
          <div class="list-content">
            <p>65296596</p>
          </div>
          <h4>Size</h4>
          <div class="list-content">
            <p>agsddfgd</p>
          </div>
          <h4>Color</h4>
          <div class="list-content">
            <p>rfytuuyuy</p>
          </div>
          <h4>Fill</h4>
          <div class="list-content">
            <p>agsddfgd</p>
          </div>
          <h4>Shadow</h4>
          <div class="list-content">
            <p>agsddfgd</p>
          </div>
        </div>
        
        <div class="chart-list chart-style" style="display:none;">
          <h4>Style1</h4>
          <h4>Style2</h4>
          <h4>Style3</h4>
          <h4>Style3</h4>
        </div>
       
      </div>
    </div>
    <div class="chart-ratio">
      <input id="rear-ratio" class="chart-ratio-form" value="100" min="50" max="300" placeholder="10" type="range" onchange="ratioDisplay()" step="10">
      <div class="rare-ratio">
        <input id="rear-ratio-display" class="chart-ratio-form" value="100" width="40" min="50" max="300" placeholder="10" type="number" onchange="ratioDisplay2()" step="10">
      </div>
      <div class="chart-ratio-cover"></div>
    </div>
  </div>

  <script src="external/jquery/jquery.js"></script>
  <script src="js/jquery-ui.js"></script>
  <script src="js/jquery.jsPlumb-1.4.0-all.js"></script>

  <script type="text/javascript">

    //指定流程图设计区域宽度高度
    function adjustDesignWidth(){
      var designWidth=0;
      var domWidth=$(window).width();

      designWidth=domWidth-$('.chart-right-panel').width();
      $('.chart-design').css('width',designWidth-4);
    }

    //滑动条改变时触发的事件
    function ratioDisplay(){
      var chartRatioDom=document.getElementById('rear-ratio');
      var chartRatioDisplayDom=document.getElementById('rear-ratio-display');
      chartRatioDisplayDom.value=chartRatioDom.value;
    }

    //大小选择框值改变时触发
    function ratioDisplay2(){
      var chartRatioDisplayDom=document.getElementById('rear-ratio-display');
      var chartRatioDom=document.getElementById('rear-ratio');
      chartRatioDom.value=chartRatioDisplayDom.value;
    }

    //设置右边属性栏当前显示的是哪个工具(object/text/style)
    function setChartRightListFlag(value){
      $('.chart-right-list-flag').html(value);
    }

    //获得当前右边属性栏当前显示的是哪个工具(object/text/style)
    function getChartRightListFlag(){
      return $('.chart-right-list-flag').html();
    }

    //负责属性面板的切换,
    //参数will代表即将要切换的属性面板[text|object|style]
    //参数current代表当前属性面板,可由getChartRightListFlag()获得
    function attrToggle(will,current){
        if(current!=will){
          $(".chart-"+current).hide();
          $('.chart-'+will).fadeIn();
          setChartRightListFlag(will);
        }
    }

    //*********************************jsPlumb基础信息配置区域*********************************

        //根蒂根基连接线样式
        var connectorPaintStyle = {
            lineWidth: 4,
            strokeStyle: "rgb(0,32,80)",
            joinstyle: "round",
            outlineColor: "rgb(251,251,251)",
            outlineWidth: 2
        };

        // 鼠标悬浮在连接线上的样式
        var connectorHoverStyle = {
            lineWidth: 4,
            strokeStyle: "#216477",
            outlineWidth: 0,
            outlineColor: "rgb(251,251,251)"
        };

        var hollowCircle = {
            endpoint: ["Dot", { radius: 8 }],  //端点的外形
            connectorStyle: connectorPaintStyle,//连接线的色彩,大小样式
            connectorHoverStyle: connectorHoverStyle,
            paintStyle: {
                strokeStyle: "rgb(0,32,80)",
                fillStyle: "rgb(0,32,80)",
                opacity: 0.5,
                radius: 2,
                lineWidth: 2
            },//端点的色彩样式
            //anchor: "AutoDefault",
            isSource: true,    //是否可以拖动(作为连线出发点)
            //connector: ["Flowchart", { stub: [40, 60], gap: 10, cornerRadius: 5, alwaysRespectStubs: true }],  //连接线的样式种类有[Bezier],[Flowchart],[StateMachine ],[Straight ]
            connector: ["Bezier", { curviness:100 } ],//设置连线为贝塞尔曲线
            isTarget: true,    //是否可以放置(连线终点)
            maxConnections: -1,    // 设置连接点最多可以连接几条线
            connectorOverlays: [["Arrow", { width: 10, length: 10, location: 1 }]]
        };

    //*********************************jsPlumb基础信息配置区域*********************************

    //*********************************流程图数据操作区域*********************************
      var list;//连接点列表

      //序列化流程图数据,json格式
      function save(){

        var connects=[];

        for(var i in list){
          for(var j in list[i]){
            connects.push({
              ConnectionId:list[i][j]['id'],
              PageSourceId:list[i][j]['sourceId'],
              PageTargetId:list[i][j]['targetId']
            });
          }
        }

        var blocks=[];
        $(".droppable .draggable").each(function(idx, elem){
          var elem=$(elem);
          blocks.push({
            BlockId:elem.attr('id'),
            BlockContent:elem.html(),
            BlockX:parseInt(elem.css("left"), 10),
            BlockY:parseInt(elem.css("top"), 10)
          });
        });

        var serliza="{"+'"connects":'+JSON.stringify(connects)+',"block":'+JSON.stringify(blocks)+"}";
        return serliza;
    }


    //*********************************流程图数据操作区域*********************************

    $(document).ready(function(){

      //**************************************UI控制部分***************************************

      //初始化动画效果
      $('.chart-ratio-form').css("opacity",'0.6');

      //为按钮,列表添加动画效果
      $('.fl-btn,h4').hover(
        function(){$(this).stop().animate({opacity:0.5},'fast');},
        function(){$(this).stop().animate({opacity:1},'fast');}
      );

      //为左下角大小调节添加动画效果
      $('.chart-ratio-form').hover(
        function(){$(this).stop().animate({opacity:1},'fast');},
        function(){$(this).stop().animate({opacity:0.6},'fast');}
      );

      //给左侧工具栏分页
      $(".chart-object").accordion();

      //调节区域双击可输入数字更改
      $('.rare-ratio').dblclick(function(){
        var chartRatioValue=document.getElementById('rear-ratio').value;       
      });

      //页面上方按钮事件
      $('.fl-btn').click(function(){
        //取被点击按钮的ID
        var flBtnID=$(this).attr('id');
        var currentListFlag=getChartRightListFlag();//当前显示的属性面板
        switch(flBtnID){
          case 'new-box':
            //新建流程图框
            break;
          case 'new-node':
            //新建结点
            break;
          case 'text-chart-align':
            //流程图框对齐或文本对齐
            break;
          case 'chart-save':
            //分享或保存(生成JSON)
            var jsondata=save();
            break;
          case 'btn-object':
            //显示object面板
            attrToggle('object',currentListFlag);
            break; 
          case 'btn-text':
            //显示text面板
            attrToggle('text',currentListFlag);
            break; 
          case 'btn-style':
            //显示style面板`
            attrToggle('style',currentListFlag);
            break;
          default:
            break;
        }
      });

      //**************************************UI控制部分***************************************

      //***********************************元素拖动控制部分************************************

      var idIndex=0;

      //允许元素拖动
      $(".list-content .area").children().draggable({ 
        //revert: "valid",//拖动之后原路返回
        helper: "clone",//复制自身
        scope: "dragflag"//标识
      });

      $(".droppable").droppable({
        accept: ".draggable", //只接受来自类.dragable的元素
        activeClass:"drop-active", //开始拖动时放置区域显示
        scope: "dragflag",
          drop:function(event,ui){
            idIndex=idIndex+1;

            //获取鼠标坐标
            var left=parseInt(ui.offset.left-$(this).offset().left);
            var top=parseInt(ui.offset.top-$(this).offset().top)+4;

            var name=ui.draggable[0].id;//返回被拖动元素的ID
            var trueId=name+"-"+idIndex;

            //在div内append元素
            $(this).append("<div class=\"draggable "+name+"\" id=\""+trueId+"\">"+$(ui.helper).html()+"</div>");
            $("#"+trueId).css("left",left).css("top",top).css("position","absolute").css("margin","0px");

            //用jsPlumb添加锚点
            jsPlumb.addEndpoint(trueId,{anchors: "TopCenter"},hollowCircle);
            jsPlumb.addEndpoint(trueId,{anchors: "RightMiddle"},hollowCircle);
            jsPlumb.addEndpoint(trueId,{anchors: "BottomCenter"},hollowCircle);
            jsPlumb.addEndpoint(trueId,{anchors: "LeftMiddle"},hollowCircle);

            jsPlumb.draggable(trueId);
            $("#"+trueId).draggable({containment: "parent"});//保证拖动不跨界

            changeValue("#"+trueId);

            list=jsPlumb.getAllConnections();//获取所有的连接
          }
      });

      //删除元素按钮
      $(".droppable").on("mouseenter",".draggable",function(){
        $(this).append("<img src=\"img\/delete.png\" id=\"fuck\" style=\"position:absolute;width:20px;height:16px;\"/>");
                  
        //因为流程图的形状不一样,所以要获取特定的流程图名称来指定删除按钮的位置
        var wholeID=$(this).attr('id');
        var wholeIDSep=wholeID.split('-');

        if(wholeIDSep[0]=="circle") {
          $("img").css("left", $(this).width()-20).css("top", 20);
        }else if(wholeIDSep[0]=="rhombus"){
          $("img").css("left", $(this).width()-18).css("top", 10);
        }else{
          $("img").css("left", $(this).width()-20).css("top", 10);
        }
      });

      $(".droppable").on("mouseleave",".draggable",function(){
        $("img").remove();
      });

      $(".droppable").on("click","img",function(){
        //要先保存父元素的DOM,因为出现确认对话框之后(this)会消失
        var parentDOM=$(this).parent();
        var parentID=parentDOM.attr('id');
        if(confirm("确定要删除吗?")) {
          jsPlumb.removeAllEndpoints(parentID);
          parentDOM.remove();
        }
      });

      //删除连接线
      jsPlumb.bind("click",function(conn,originalEvent){
        if(confirm("确定删除吗?")){
          jsPlumb.detach(conn);
        }
      });

      //双击修改文本
      function changeValue(id){
        $(id).dblclick(function(){
            var text=$(this).text();
            $(this).html("");
            $(this).append("<input type=\"text\" value=\"" + text + "\" />");
            $(this).mouseleave(function(){
                $(this).html($("input[type=\"text\"]").val());
            });
        });
      }

      //***********************************元素拖动控制部分************************************
    });
  </script>
</body>
</html>
