<!DOCTYPE>
<html>
<head>
	<title>工作流程图</title>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="css/style.css">
</head>

<body>

  <div class="top-panel">
    <div class="top-left-panel">
      <input type="button" class="fl-btn" id="new-box" value="新部件">
      <input type="button" class="fl-btn" id="line-mode" value="线条">
      <input type="button" class="fl-btn" id="text-chart-align" value="对齐">
      <input type="button" class="fl-btn" id="chart-save" value="保存">
    </div>
    <div class="top-right-panel">
      <input type="button" class="fl-btn" id="btn-object" value="Object">
      <input type="button" class="fl-btn" id="btn-text" value="Text">
      <input type="button" class="fl-btn" id="btn-style" value="Style">
    </div>
  </div>
  <div class="chart-content">
    <div id="chart-container" class="chart-design droppable"></div>
    <div class="chart-right-panel">
      <div class="chart-right-list">
        <div class="chart-right-list-flag" style="display:none;visibility:hidden;">object</div>
        <div class="chart-list chart-object">
          <h4>Shape</h4>
          <div class="list-content">
              <div class="area">
                <div class="draggable" id="rect">文本</div>
                <div class="draggable roundedRect" id="roundedRect">文本</div>
                <div class="draggable circle" id="circle">文本</div>
                <div class="draggable rhombus" id="rhombus">文本</div>
              </div>
          </div>

          <h4>Location</h4>
          <div class="list-content">
            <div class="lo-xy-display">
              <label>Top:</label><input id="lo-x-display" type="text" class="chart-location-form" value="0" width="40">
              <p></p>
              <label>Left:</label><input id="lo-y-display" type="text" class="chart-location-form" value="0" width="40">
            </div>
          </div>

          <h4>Size</h4>
          <div class="list-content">
            <div class="lo-xy-display">
              <label>width:</label><input id="chart-width-display" type="number" class="chart-location-form" value="0" width="40">
              <p></p>
              <label>height:</label><input id="chart-height-display" type="number" class="chart-location-form" value="0" width="40">
            </div>
          </div>

          <h4>Fill</h4>
          <div class="list-content">
            <div class="lo-xy-display chart-fill-display">
              <label>填充颜色:</label><input id="chart-color-display" type="text" class="chart-location-form" value="0" width="40">
              <p></p>
              <label>线粗:</label><input id="chart-stroke-width-display" type="number" class="chart-location-form" value="0" width="40">
              <p></p>
              <label>线颜色:</label><input id="chart-line-color-display" type="text" class="chart-location-form" value="0" width="40">
            </div>
          </div>

          <h4>Stroke</h4>
          <div class="list-content">
            <div class="lo-xy-display chart-fill-display">
              <label>填充颜色:</label><input id="chart-color-display" type="text" class="chart-location-form" value="0" width="40">
              <p></p>
              <label>线粗:</label><input id="chart-stroke-width-display" type="number" class="chart-location-form" value="0" width="40">
              <p></p>
              <label>线颜色:</label><input id="chart-line-color-display" type="text" class="chart-location-form" value="0" width="40">
            </div>
          </div>

          <h4>Shadow</h4>
          <div class="list-content">
            <div class="lo-xy-display chart-shadow-display">
              <label>Shadow:</label><input id="chart-width-display" type="number" class="chart-location-form" value="0" width="40">
              <p></p>
            </div>
          </div>
        </div>

        <div class="chart-list chart-text" style="display:none;">
          <h4>Font</h4>
          <div class="list-content">
            <div class="chart-font-display">
              <label>Font:</label><input id="chart-font-display" type="text" class="chart-location-form" value="微软雅黑" width="40">
              <p></p>
            </div>
          </div>
          <h4>Size</h4>
          <div class="list-content">
            <div class="chart-font-display">
              <label>Font:</label><input id="chart-font-size-display" type="number" class="chart-location-form" value="14" width="40">
              <p></p>
            </div>
          </div>
          <h4>Lign</h4>
          <div class="list-content">
            <div class="chart-font-display">
              <label>Align:</label><input id="chart-align-display" type="text" class="chart-location-form" value="居中" width="40">
              <p></p>
            </div>
          </div>
          <h4>Color</h4>
          <div class="list-content">
            <div class="chart-font-display">
              <label>Color:</label><input id="chart-text-color-display" type="text" class="chart-location-form" value="rgb(0,0,0)" width="40">
              <p></p>
            </div>
          </div>
          <h4>JSON</h4>
          <div class="list-content">
            <div class="chart-font-display">
              <label>JSON:</label><textarea id="json-display-area"></textarea>
              <p></p>
            </div>
          </div>
        </div>
        
        <div class="chart-list chart-style" style="display:none;">
          <h4>default</h4>
          <h4>dark</h4>
          <h4>blue</h4>
          <h4>green</h4>
          <h4>pink</h4>
        </div>
       
      </div>
    </div>
    <div class="chart-ratio">
      <input id="rear-ratio" class="chart-ratio-form" value="100" min="50" max="300" placeholder="10" type="range" onchange="ratioDisplay()" step="10">
      <div class="rare-ratio">
        <input id="rear-ratio-display" class="chart-ratio-form" value="100" width="40" min="50" max="300" placeholder="10" type="number" onchange="ratioDisplay2()" step="10">
      </div>
      <div class="chart-ratio-cover"></div>
    </div>

    <div class="line-select" id="line-select-div" style="display:none">
    <div class="chart-list chart-style">
      <h4 class="top-menu-selector" id="line-Straight">直线</h4>
      <h4 class="top-menu-selector" id="line-Bezier">曲线</h4>
      <h4 class="top-menu-selector" id="line-Flowchart">流程线</h4>
    </div>
    </div>

    <div class="line-select" id="align-select-div" style="display:none">
    <div class="chart-list chart-style">
      <h4 class="top-menu-selector" id="align-left">居左</h4>
      <h4 class="top-menu-selector" id="align-center">居中</h4>
      <h4 class="top-menu-selector" id="align-right">居右</h4>
    </div>
    </div>
  </div>

  <script src="external/jquery/jquery.js"></script>
  <script src="js/jquery-ui.js"></script>
  <script src="js/jquery.jsPlumb-1.4.0-all.js"></script>

  <script type="text/javascript">
       
    //标识右侧工具栏是否已显示,默认显示
    sessionStorage['rightToolsIsDisplay']=true;

    //标识当前点击的流程图框,默认为none
    sessionStorage['currentChartSelected']='none';

    //栈,记录用户操作的先后顺序,用来进行撤销操作,数据结构为JSON,期中的copy用来复制部件
    //是个二维栈,包括新增/删除/粘贴操作
    var chartOperationStack=new Array;
    chartOperationStack['add']=[];
    chartOperationStack['delete']=[];
    chartOperationStack['paste']=[];
    chartOperationStack['copy']=[];

    //记录用户具体操作,有copy,add,delete,paste
    var chartRareOperationStack=new Array;

    //指定流程图设计区域宽度高度
    function adjustDesignWidth(){
      var designWidth=0;
      var domWidth=$(window).width();

      designWidth=domWidth-$('.chart-right-panel').width();
      $('.chart-design').css('width',designWidth-4);
    }

    //对页面进行缩小或放大
    function setZoom(instance,scale,container){
      //jsPlumb.setContainer("chart-container");
      $("#"+container).css({
        "-webkit-transform":"scale("+scale+")",
        "-moz-transform":"scale("+scale+")",
        "-ms-transform":"scale("+scale+")",
        "-o-transform":"scale("+scale+")",
        "transform":"scale("+scale+")",
        "TransformOrigin":"0% 0%"
      });
      instance.setZoom(scale);
    }

    //滑动条改变时触发的事件
    function ratioDisplay(){
      var chartRatioDom=document.getElementById('rear-ratio');
      var chartRatioDisplayDom=document.getElementById('rear-ratio-display');
      chartRatioDisplayDom.value=chartRatioDom.value;
      setZoom(jsPlumb,chartRatioDom.value/100,'chart-container');
      $('#chart-container').css({
        'left':'0px',
        'right':'180px'
      });
    }

    //大小选择框值改变时触发
    function ratioDisplay2(){
      var chartRatioDisplayDom=document.getElementById('rear-ratio-display');
      var chartRatioDom=document.getElementById('rear-ratio');
      chartRatioDom.value=chartRatioDisplayDom.value;
      setZoom(jsPlumb,chartRatioDisplayDom.value/100,'chart-container');
      $('#chart-container').css({
        'left':'0px',
        'right':'180px'
      });
    }

    //设置右边属性栏当前显示的是哪个工具(object/text/style)
    function setChartRightListFlag(value){
      $('.chart-right-list-flag').html(value);
    }

    //获得当前右边属性栏当前显示的是哪个工具(object/text/style)
    function getChartRightListFlag(){
      return $('.chart-right-list-flag').html();
    }

    //负责属性面板的切换,
    //参数will代表即将要切换的属性面板[text|object|style]
    //参数current代表当前属性面板,可由getChartRightListFlag()获得
    function attrToggle(will,current){
        if(sessionStorage['rightToolsIsDisplay']=='false'){
          $('.chart-right-panel').show();
          sessionStorage['rightToolsIsDisplay']=true;
          if(current!=will){
            $('.chart-design').css("right","230px");
            console.log('sasaas');
            $(".chart-"+current).hide();
            $('.chart-'+will).fadeIn();
            setChartRightListFlag(will);
          }
          $('.chart-design').css("right","230px");
        }else{
          $('.chart-right-panel').hide();
          sessionStorage['rightToolsIsDisplay']=false;
          //递归调用切换属性面板函数
          attrToggle(will,current);
          $('.chart-design').css("right","0px");//扩充设计区域宽度
          if(will==current){
            //如果当前点击的和将要切换的属性面板相同则隐藏整个右侧
            $('.chart-right-panel').hide();
            sessionStorage['rightToolsIsDisplay']=false;
          }else{
            //如果当前点击和将要切换的属性面板不同则缩小设计区域宽度
            $('.chart-design').css("right","230px");
          }
        }
    }

    //****************负责属性面板的内容设置*****************
      
      //设置当前部件top,left
      function setChartLocation(top,left){
        $('#lo-x-display').val(top);
        $('#lo-y-display').val(left);
      }

      //获得当前部件top,left,返回一个数组,第一个元素是'top',第二个元素是'left'
      function getChartLocation(){
        var location=new Array();
        location['top']=$('#lo-x-display').val();
        location['left']=$('#lo-y-display').val();
        return location;
      }

      //设置当前部件的width和height
      function setChartSize(width,height){
        $('#chart-width-display').val(width);
        $('#chart-height-display').val(height);
      }

      //获得当前部件的width和height,返回一个数组,第一个元素是'width',第二个元素是'height'
      function getChartSize(){
        var size=new Array();
        size['width']=$('#chart-width-display').val();
        size['height']=$('#chart-height-display').val();
        return size;
      }

      //设置当前部件的字体
      function setChartFont(font){
        $('#chart-font-display').val(font);
      }

      function getChartFont(){
        var font=$('#'+sessionStorage['currentChartSelected']).css('font');
        return (font=='') ? '微软雅黑':font;
      }

      //设置当前部件的字体大小
      function setChartFontSize(size){
        $('#chart-font-size-display').val(size);
      }

      //取当前部件的字体大小
      function getChartFontSize(){
        var fontSize=$('#'+sessionStorage['currentChartSelected']).css('font-size');
        return (fontSize=='') ? 12:fontSize.substring(0,fontSize.length-2);
      }

      //设置当前部件的对齐方式
      function setChartAlign(lign){
        $('#chart-align-display').val(lign);
      }

      //取当前部件的对齐方式
      function getChartAlign(){
        var align=$('#'+sessionStorage['currentChartSelected']).css('text-align');
        var lignArray={'center':'居中','left':'居左','right':'居右'};
        return (align=='') ? '居中':lignArray[align];
      }

      //设置当前部件的字体颜色,参数color只能为rgb或16进制颜色值
      function setChartFontColor(color){
        $('#chart-text-color-display').val(color);
      }

      //取当前部件的字体颜色
      function getChartFontColor(){
        var color=$('#'+sessionStorage['currentChartSelected']).css('color');
        return (color=='') ? 'rgb(0,0,0)':color;
      }

      //设置json展示框的数据
      function setChartJson2Box(json){
        $('#json-display-area').val(json);
      }

    //****************负责属性面板的内容设置*****************

    //*********************************jsPlumb基础信息配置区域*********************************

        //流程图ID唯一标识,用来防止重复,每次新建一个部件时此值必须加1,否则会出现异常
        sessionStorage['idIndex']=0;

        //检测设计区域中间区域是否被占据,页面刚加载时默认没有被占据
        sessionStorage['midIsOccupied']='not';

        //根蒂根基连接线样式
        var connectorPaintStyle = {
            lineWidth: 4,
            strokeStyle: "rgb(0,32,80)",
            joinstyle: "round",
            outlineColor: "rgb(251,251,251)",
            outlineWidth: 2
        };

        // 鼠标悬浮在连接线上的样式
        var connectorHoverStyle = {
            lineWidth: 4,
            strokeStyle: "#216477",
            outlineWidth: 0,
            outlineColor: "rgb(251,251,251)"
        };

        var hollowCircle = {
            endpoint: ["Dot", { radius: 8 }],  //端点的外形
            connectorStyle: connectorPaintStyle,//连接线的色彩,大小样式
            connectorHoverStyle: connectorHoverStyle,
            paintStyle: {
                strokeStyle: "rgb(0,32,80)",
                fillStyle: "rgb(0,32,80)",
                opacity: 0.5,
                radius: 2,
                lineWidth: 2
            },//端点的色彩样式
            //anchor: "AutoDefault",
            isSource: true,    //是否可以拖动(作为连线出发点)
            //connector: ["Flowchart", { stub: [40, 60], gap: 10, cornerRadius: 5, alwaysRespectStubs: true }],  //连接线的样式种类有[Bezier],[Flowchart],[StateMachine ],[Straight ]
            connector: ["Bezier", { curviness:100 } ],//设置连线为贝塞尔曲线
            isTarget: true,    //是否可以放置(连线终点)
            maxConnections: -1,    // 设置连接点最多可以连接几条线
            connectorOverlays: [["Arrow", { width: 10, length: 10, location: 1 }]]
        };

        //设置线条展现方式为Straight
        function setLineStraight(){hollowCircle['connector'][0]='Straight';}
        
        //设置线条展现方式为Bezier
        function setLineBezier(){hollowCircle['connector'][0]='Bezier';}

        //设置线条展现方式为Flowchart
        function setLineFlowchart(){hollowCircle['connector'][0]='Flowchart';}

        //灵活设置线条表现方式,参数type只能为Straight|Bezier|Flowchart
        function setChartLineType(type){hollowCircle['connector'][0]=type;}

        //设置流程框内字体对齐方式
        //参数type只能为left,right或者center
        //参数ele若留空则默认全局设置,默认为空
        function setChartTextAlign(ele='',type){
          if(ele==''){
            $('.draggable').css('text-align',type);
          }else{
            $("#"+ele).css('text-align',type);
          }
        }

    //*********************************jsPlumb基础信息配置区域*********************************

    //*********************************流程图数据操作区域*********************************
      var list=[];//全部的连接点列表

      //序列化全部流程图数据,json格式
      function save(){

        var connects=[];

        for(var i in list){
          for(var j in list[i]){
            connects.push({
              ConnectionId:list[i][j]['id'],
              PageSourceId:list[i][j]['sourceId'],
              PageTargetId:list[i][j]['targetId']
            });
          }
        }

        var blocks=[];
        $(".droppable .draggable").each(function(idx, elem){
          var elem=$(elem);
          blocks.push({
            BlockId:elem.attr('id'),
            BlockContent:elem.html(),
            BlockX:parseInt(elem.css("left"), 10),
            BlockY:parseInt(elem.css("top"), 10),
            BlockWidth:parseInt(elem.css("width"),10),
            BlockHeight:parseInt(elem.css("height"),10)
          });
        });

        var serliza="{"+'"connects":'+JSON.stringify(connects)+',"block":'+JSON.stringify(blocks)+"}";
        console.log(serliza);
        return serliza;
    }

    //生成单个流程图数据,用在新建流程图框时使用
    //参数ID表示被push进栈的ID
    function getSingleChartJson(id){

      var chartNum=list.length;

      //获得最新的流程图框
      var latestChart=list[list.length-1];

      var connects=[];

      for(var j in latestChart){
        connects.push({
          ConnectionId:latestChart[j]['id'],
          PageSourceId:latestChart[j]['sourceId'],
          PageTargetId:latestChart[j]['targetId']
        });
      }

      var blocks=[];
      var elem=$("#"+id);
      var rareHTML=elem.html();
      console.log('sss'+rareHTML);
      var resultHTML=rareHTML;
      //去掉在进行复制操作时误复制的img部件
      if(rareHTML.indexOf('<img src=\"img/delete.png\"')!=-1){
        rareHTML=rareHTML.split('<img src=\"img/delete.png\"');
        resultHTML=rareHTML[0];
      }
      blocks.push({
        BlockId:elem.attr('id'),
        BlockContent:resultHTML,
        BlockX:parseInt(elem.css("left"), 10),
        BlockY:parseInt(elem.css("top"), 10),
        BlockWidth:parseInt(elem.css("width"),10),
        BlockHeight:parseInt(elem.css("height"),10)
      });

      var serliza="{"+'"connects":'+JSON.stringify(connects)+',"block":'+JSON.stringify(blocks)+"}";
      console.log(serliza);
      return serliza;
    }

    //双击修改文本
    function changeValue(id){
      $(id).dblclick(function(){
        var text=$(this).text();
        $(this).html("");
        $(this).append("<input class=\"chart-text-edit\" type=\"text\" value=\"" + text + "\" />");
        $(this).mouseleave(function(){
          $(this).html($(".chart-text-edit").val());
        });
      });
    }

    //新增一个部件
    //参数newChartArea代表新增部件的区域
    //参数chartID代表新流程图部件的ID,格式为元素名称-index
    //参数left,top代表新部件的插入位置
    //参数blockName代表新部件的文本
    //参数undo表示是否进行撤销操作,如果进行撤销操作则不进行入栈,默认为false
    function addNewChart(newChartArea,chartID,left,top,blockName,undo=false){

      var name=chartID.split('-')[0];

      //在div内append元素
      $(newChartArea).append("<div class=\"draggable "+name+" new-"+name+"\" id=\""+chartID+"\">"+blockName+"</div>");
      $("#"+chartID).css("left",left).css("top",top).css("position","absolute").css("margin","0px");

      //用jsPlumb添加锚点
      jsPlumb.addEndpoint(chartID,{anchors: "TopCenter"},hollowCircle);
      jsPlumb.addEndpoint(chartID,{anchors: "RightMiddle"},hollowCircle);
      jsPlumb.addEndpoint(chartID,{anchors: "BottomCenter"},hollowCircle);
      jsPlumb.addEndpoint(chartID,{anchors: "LeftMiddle"},hollowCircle);

      jsPlumb.draggable(chartID);
      $("#"+chartID).draggable({containment: "parent"});//保证拖动不跨界

      sessionStorage['idIndex']=sessionStorage['idIndex']+1;

      changeValue("#"+chartID);

      if(undo==false){
        chartOperationStack['add'].push(getSingleChartJson(chartID));
        chartRareOperationStack.push('add');
      }
    }

    //删除一个流程框图,若参数undo为true则在进行操作时不进行入栈操作,默认为false
    function deleteChart(id,undo=false){
        var DOM=$('#'+id);
        if(undo==false){
          chartOperationStack['delete'].push(getSingleChartJson(id));
        }
        jsPlumb.removeAllEndpoints(id);
        DOM.remove();
        if(undo==false){
          chartRareOperationStack.push('delete');
        }
    }

    //设置流程框图宽度,如果当前选择的部件为none则默认改变全局,下同
    function setChartDesignWidth(width){
      if(sessionStorage['currentChartSelected']=='none'){
        $('.draggable').css('width',width);
      }else{
        $('#'+sessionStorage['currentChartSelected']).css('width',width);
      }
    }

    //设置流程框图高度
    function setChartDesignHeight(height){
      if(sessionStorage['currentChartSelected']=='none'){
        $('.draggable').css('width',width);
      }else{
        $('#'+sessionStorage['currentChartSelected']).css('height',height);
      }
    }

    //设置流程框图top
    function setChartDesignTop(top){
      if(sessionStorage['currentChartSelected']=='none'){
        $('.draggable').css('width',width);
      }else{
        $('#'+sessionStorage['currentChartSelected']).css('top',top);
      }
    }

    //设置流程框图left
    function setChartDesignLeft(left){
      if(sessionStorage['currentChartSelected']=='none'){
        $('.draggable').css('width',width);
      }else{
        $('#'+sessionStorage['currentChartSelected']).css('left',left);
      }
    }

    //设置流程框图字体
    function setChartDesignFont(font){
      if(sessionStorage['currentChartSelected']=='none'){
        $('.draggable').css('width',width);
      }else{
        $('#'+sessionStorage['currentChartSelected']).css('font',font);
      }
    }

    //设置流程框图字体大小
    function setChartDesignFontSize(size){
      if(sessionStorage['currentChartSelected']=='none'){
        $('.draggable').css('width',width);
      }else{
        $('#'+sessionStorage['currentChartSelected']).css('font-size',size);
      }
    }

    //设置流程框图字体颜色
    function setChartFontColor(color){
      if(sessionStorage['currentChartSelected']=='none'){
        $('.draggable').css('width',width);
      }else{
        $('#'+sessionStorage['currentChartSelected']).css('color',color);
      }
    }


    //*********************************流程图数据操作区域*********************************

    $(document).ready(function(){

      //**************************************UI控制部分***************************************

      //初始化动画效果
      $('.chart-ratio-form').css("opacity",'0.6');

      //隐藏右侧属性面板
      //$('.chart-right-panel').hide();

      //为按钮,列表添加动画效果
      $('.fl-btn,h4').hover(
        function(){$(this).stop().animate({opacity:0.5},'fast');},
        function(){$(this).stop().animate({opacity:1},'fast');}
      );

      //为左下角大小调节添加动画效果
      $('.chart-ratio-form').hover(
        function(){$(this).stop().animate({opacity:1},'fast');},
        function(){$(this).stop().animate({opacity:0.6},'fast');}
      );

      //给左侧工具栏分页
      $(".chart-object").accordion();

      //调节区域双击可输入数字更改
      $('.rare-ratio').dblclick(function(){
        var chartRatioValue=document.getElementById('rear-ratio').value;       
      });

      //页面上方按钮事件
      
      //标识线条选择器有没有被展开,默认不展开
      sessionStorage['topLineSelectIsDisplayed']=false;
      //标识排列选择器有没有被展开,默认不展开
      sessionStorage['topAlignSelectIsDisplayed']=false;

      //对页面上方的工具菜单进行折叠
      function selectorToggle(event,element){
        //取消事件冒泡
        event.stopPropagation();
        //设置弹出层的位置
        var offset=$(event.target).offset();
        $(element).css({
          top:offset.top+$(event.target).height()+"px",
          left:offset.left
        });

        //按钮的toggle,如果div是可见的,点击按钮切换为隐藏的;如果是隐藏的,切换为可见的。  
        $(element).toggle('fast');
      }

      //上方工具栏的按钮点击事件
      $('.fl-btn').click(function(event){
        //取被点击按钮的ID
        var flBtnID=$(this).attr('id');
        var currentListFlag=getChartRightListFlag();//当前显示的属性面板
        switch(flBtnID){
          case 'new-box':
            //新建流程图框
            if(sessionStorage['midIsOccupied']=='not'){
              //如果中间位置没有被占据则在中间位置新建一个部件
              var left=$('.chart-design').width()/2;
              var top=$('.chart-design').height()/2;
              addNewChart('.chart-design',"roundedRect-"+sessionStorage['idIndex'],left,top-20,'新部件');
              sessionStorage['midIsOccupied']='yes';
              console.log(sessionStorage['midIsOccupied']);
            }else{
              //如果中间位置被占据则根据随机数新建一个部件
              var randomLeft=Math.ceil(Math.random()*$('.chart-design').width());
              var randomTop=Math.ceil(Math.random()*($('.chart-design').height()-25));
              addNewChart('.chart-design',"roundedRect-"+sessionStorage['idIndex'],randomLeft,randomTop,'新部件');
            }
            break;
          case 'line-mode':
            //设置线条样式

            if(sessionStorage['topAlignSelectIsDisplayed']=='true'){
                $('#align-select-div').toggle('fast');
                sessionStorage['topAlignSelectIsDisplayed']=false;
                console.log('dssd');
            }
            
            selectorToggle(event,'#line-select-div');
            sessionStorage['topLineSelectIsDisplayed']=true;
            break;
          case 'text-chart-align':
            //流程图框对齐或文本对齐

            if(sessionStorage['topLineSelectIsDisplayed']=='true'){
                $('#line-select-div').toggle('fast');
                sessionStorage['topLineSelectIsDisplayed']=false;
            }
            
            selectorToggle(event,'#align-select-div');
            sessionStorage['topAlignSelectIsDisplayed']=true;
            break;
          case 'chart-save':
            //分享或保存(生成JSON)
            var jsondata=save();
            break;
          case 'btn-object':
            //显示object面板
            attrToggle('object',currentListFlag);
            break; 
          case 'btn-text':
            //显示text面板
            attrToggle('text',currentListFlag);
            break; 
          case 'btn-style':
            //显示style面板`
            attrToggle('style',currentListFlag);
            break;
          default:
            break;
        }
      });

      //**************************************UI控制部分***************************************

      //***********************************元素拖动控制部分************************************

      //允许元素拖动
      $(".list-content .area").children().draggable({ 
        //revert: "valid",//拖动之后原路返回
        helper: "clone",//复制自身
        scope: "dragflag"//标识
      });

      $(".droppable").droppable({
        accept: ".draggable", //只接受来自类.dragable的元素
        activeClass:"drop-active", //开始拖动时放置区域显示
        scope: "dragflag",
          drop:function(event,ui){

            sessionStorage['idIndex']=sessionStorage['idIndex']+1;

            //获取鼠标坐标
            var left=parseInt(ui.offset.left-$(this).offset().left);
            var top=parseInt(ui.offset.top-$(this).offset().top)+4;

            setChartLocation(top,left);//设置坐标

            var name=ui.draggable[0].id;//返回被拖动元素的ID
            var trueId=name+"-"+sessionStorage['idIndex'];

            //在div内append元素
            $(this).append("<div class=\"draggable "+name+" new-"+name+"\" id=\""+trueId+"\">"+$(ui.helper).html()+"</div>");
            $("#"+trueId).css("left",left).css("top",top).css("position","absolute").css("margin","0px");

            //用jsPlumb添加锚点
            jsPlumb.addEndpoint(trueId,{anchors: "TopCenter"},hollowCircle);
            jsPlumb.addEndpoint(trueId,{anchors: "RightMiddle"},hollowCircle);
            jsPlumb.addEndpoint(trueId,{anchors: "BottomCenter"},hollowCircle);
            jsPlumb.addEndpoint(trueId,{anchors: "LeftMiddle"},hollowCircle);

            jsPlumb.draggable(trueId);
            $("#"+trueId).draggable({containment: "parent"});//保证拖动不跨界

            changeValue("#"+trueId);

            list=jsPlumb.getAllConnections();//获取所有的连接

            //元素ID网上加,防止重复
            sessionStorage['idIndex']=sessionStorage['idIndex']+1;

            //设置当前选择的流程框图
            sessionStorage['currentChartSelected']=trueId;

            //将新拖进来的流程图框JSON数据push进栈
            chartOperationStack['add'].push(getSingleChartJson(trueId));
            chartRareOperationStack.push('add');
          }
      });

      $('.droppable .draggable').resizable({
        ghost: true
      });

      //删除元素按钮
      $(".droppable").on("mouseenter",".draggable",function(){
        $(this).append("<img src=\"img\/delete.png\" id=\"fuck\" style=\"position:absolute;width:20px;height:16px;\"/>");
                  
        //因为流程图的形状不一样,所以要获取特定的流程图名称来指定删除按钮的位置
        var wholeID=$(this).attr('id');
        var wholeIDSep=wholeID.split('-');

        if(wholeIDSep[0]=="circle") {
          $("img").css("left", $(this).width()-20).css("top", 20);
        }else if(wholeIDSep[0]=="rhombus"){
          $("img").css("left", $(this).width()-18).css("top", 10);
        }else{
          $("img").css("left", $(this).width()-20).css("top", 10);
        }
      });

      $(".droppable").on("mouseleave",".draggable",function(){
        $("img").remove();
      });

      $(".droppable").on("click","img",function(){
        //要先保存父元素的DOM,因为出现确认对话框之后(this)会消失
        var parentDOM=$(this).parent();
        var parentID=parentDOM.attr('id');
        if(confirm("确定要删除吗?")) {
          chartOperationStack['delete'].push(getSingleChartJson(parentID));
          jsPlumb.removeAllEndpoints(parentID);
          parentDOM.remove();
          chartRareOperationStack.push('delete');
        }
      });

      //设计区域元素被点击事件,同步右侧属性面板
      $('.droppable').on('click','.draggable',function(){
        //获得当前选择部件的ID
        sessionStorage['currentChartSelected']=$(this).attr('id');

        //设置当前部件的坐标和大小
        setChartLocation($(this).offset().top,$(this).offset().left);
        setChartSize($(this).width(),$(this).height());

        //设置当前选择部件的字体
        setChartFont(getChartFont());

        //设置当前选择部件的字体大小
        setChartFontSize(getChartFontSize());

        //设置当前选择部件的对齐方式
        setChartAlign(getChartAlign());

        //设置当前选择部件的字体颜色
        setChartFontColor(getChartFontColor());

        //设置JSON数据放置区域的值
        setChartJson2Box(getSingleChartJson(sessionStorage['currentChartSelected']));
      });

      $('.droppable').on('dblclick',function(){
        sessionStorage['currentChartSelected']='none';//置当前选择的流程图框为空
      });

      //页面顶部工具栏选择事件
      $('.line-select').on('click','.top-menu-selector',function(){
        var idSelected=$(this).attr('id').split('-');
        if(idSelected[0]=='line'){
          setChartLineType(idSelected[1]);
        }else if(idSelected[0]=='align'){
          if(sessionStorage['currentChartSelected']!='none'){
            setChartTextAlign(sessionStorage['currentChartSelected'],idSelected[1]);
          }else{
            setChartTextAlign('',idSelected[1]);
          }
          
        }
      });

      //设计区域元素被拖动时,触发同步坐标
      /*$(".droppable").droppable({
        activate:function(event,ui){
          console.log('sdsd');
          //console.log(this);
          setChartLocation($(this).offset().top,$(this).offset().left);
        }
      });*/

      $(".draggable").draggable({
        start:function(){
          console.log('start');
        },
        drag:function(){
          console.log('drag');
        },
        stop:function(){
          console.log('stop');
        }
      });

      //********右侧属性面板内容改变同步到设计区域*********

      ////////预加载
      jQuery(function($){
        txtValue=$(".chart-location-form").val();
        ////////    给txtbox绑定键盘事件
        $(".chart-location-form").bind("keydown",function(){
          var currentValue=$(this).val();
          var currentID=$(this).attr('id');
          if(currentValue!=txtValue){
            switch(currentID){
              case 'chart-font-display'://字体
                break;
              case 'chart-font-size-display'://字体大小
                break;
              case 'chart-align-display'://字体对齐样式
                break;
              case 'chart-text-color-display'://字体颜色
                break;
              case 'lo-x-display'://top
                break;
              case 'lo-y-display'://left
                break;
              case 'chart-width-display'://宽度
                break;
              case 'chart-height-display'://高度
                break;
              default:
                break;
            }
          }
        });
      });

      //////  目标选择框文本发生更改时触发的事件,根据ID不同
      function TxtChange() {
        alert('');  
      }

      //********右侧属性面板内容改变同步到设计区域*********

      //删除连接线
      jsPlumb.bind("click",function(conn,originalEvent){
        if(confirm("确定删除吗?")){
          jsPlumb.detach(conn);
        }
      });

      //DOCUMENT快捷键操作
      $(document).on("keydown", function(event){
        if(event.ctrlKey && event.which==90){
          //按下 CTRL+Z 进行撤销操作
          var rareOperation=chartRareOperationStack.pop();//取出用户最近一次的操作
          var operationJSON=chartOperationStack[rareOperation].pop();//根据用户最后一次进行的操作弹出最近一次的流程框图数据
          operationJSON=JSON.parse(operationJSON);
          var chartOperationData=operationJSON['block'][0];
          switch(rareOperation){
            case 'delete':
              //用户操作为删除,撤销操作为添加
              addNewChart('.chart-design',chartOperationData['BlockId']+sessionStorage['idIndex'],chartOperationData['BlockX'],chartOperationData['BlockY'],chartOperationData['BlockContent'],true);
              break;
            case 'add':
              //用户操作为添加,撤销操作为删除
              deleteChart(chartOperationData['BlockId'],true);
              break;
            case 'paste':
              //用户操作为粘贴,撤销操作为删除
              console.log(chartOperationData['BlockId']);
              deleteChart(chartOperationData['BlockId'],true);
              break;
          }
        }
        if(event.ctrlKey && event.which==67){
          //CTRL+C 进行复制部件操作
          if(sessionStorage['currentChartSelected']!='none'){
            chartOperationStack['copy'].push(getSingleChartJson(sessionStorage['currentChartSelected']));
            //console.log(sessionStorage['currentChartSelected']);
            chartRareOperationStack.push('copy');
          }
        }
        if(event.ctrlKey && event.which==86){
          //CTRL+V 进行粘贴部件操作
          var chartCopiedJson=chartOperationStack['copy'][chartOperationStack['copy'].length-1];
          var unpackChart=JSON.parse(chartCopiedJson);
          var chartBlockObj=unpackChart['block'][0];
          var chartPastedID=chartBlockObj['BlockId']+sessionStorage['idIndex'];//设置被粘贴部件的新ID
          if(unpackChart['connects'].length==0){
            addNewChart('.chart-design',chartPastedID,chartBlockObj['BlockX'],chartBlockObj['BlockY']-20,chartBlockObj['BlockContent']);
          }else{
          }
          unpackChart['block'][0]['BlockId']=chartPastedID;
          chartOperationStack['paste'].push(JSON.stringify(unpackChart));
          chartRareOperationStack.push('paste');
        }
        if(event.which==46){
          //DELETE 进行删除部件操作
          if(sessionStorage['currentChartSelected']!='none'){
            if(confirm("确定要删除吗?")){
              deleteChart(sessionStorage['currentChartSelected']);
              setChartLocation(0,0);
              setChartSize(0,0);
            }
          }
        }
      });
      
      //点击空白处或者自身隐藏弹出层，下面分别为滑动和淡出效果。  
      $(document).click(function(event){
        $('.line-select').slideUp('fast');
        sessionStorage['topLineSelectIsDisplayed']=false;
        sessionStorage['topAlignSelectIsDisplayed']=false;
      });

      //***********************************元素拖动控制部分************************************
    });
  </script>
</body>
</html>
